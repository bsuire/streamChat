<!doctype html>
<html>
<head>
    <title>streamChat!</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font: 13px Helvetica, Arial; }
        
        #lobby { width: 15%; height:100%; position: absolute; top: 0px; right: 0px; border-style:solid; border-width:6px; border-color: #58ACFA; background-color: #58ACFA } 
        #lobby p { background: #58ACFA; text-align:center; padding:10px; }
        #dragboxes p { background: #66CCFF; text-align:center; padding:10px; border-style:solid none solid none;  border-width:3px; border-color: #58ACFA } 
        #lobby form input { width: 100%; padding:5px; }
        #lobby ul { border-bottom-style:solid; border-bottom-width:3px; border-color: #58ACFA } 
        #users { list-style-type: none; margin: 0; padding: 0; }
        #users li { padding: 5px 10px; }
        #users li:nth-child(odd) { background: #eee; }
        #users li:nth-child(even) { background: #fff; }
        div dragboxes { width:100%; height: 40px; position: absolute; bottom: 0px; right: 0px; border-style:solid; border-width:5px; background: #66CCFF } 
          
        #room { width: 85%; height:100%; position: absolute; top: 0px; left: 0px; }  
        #chat { width: 100%; height:90%; position: absolute; top: 0px; left: 0px; border-style: solid none none solid; border-width:6px; border-color: #58ACFA; overflow:scroll; } 
        #chatform { width: 100%; height: 10%; position: absolute; bottom: 0px; left: 0px; border-style:solid none solid solid; border-width:6px; border-color: #58ACFA; } 
        #room form { background: #000; padding: 3px;  width: 100%; height: 100%; }
        #room form input { border: 0; padding: 10px; width: 90%; height:100%}
        #room form button { width: 9.6%; background: #66CCFF; margin: 1px 0.2%;border: none; padding: 10px; height:100% }
        #messages { list-style-type: none; margin: 0; padding: 0; }
        #messages li { padding: 5px 10px; }
        #messages li:nth-child(odd) { background: #eee; }
    </style>
</head>
<body>
    <div id="room">
        <div id="chat"> 
            <ul id="messages"></ul>
        </div>
        <div id="chatform"> 
            <form action="">
                <input id="m" autocomplete="off" /><button>Send</button>
            </form>
        </div>
    </div>
    <div id = "lobby">
        <div id = "lobbyheader">
            <p> Who's Online? </p>
        </div>
            <form action="">
                <input id="search" type="text" placeholder="type in friend's username" />
            </form>
            <ul id="users"></ul>
        <div id = "dragboxes">
            <div id="currentchatbox" ondrop="drop(event,'current')" ondragover="allowDrop(event)">
                <p> Add to <b>This</b> Chat </p>
            </div>
            <div id="newchatbox" ondrop="drop(event,'new')" ondragover="allowDrop(event)">
                <p> Add to <b>New</b> Chat </p>
            </div>
        </div>
        <div id = "lobbyfooter">
            <p> Drag and drop users onto one of the above boxes to add them to chat </p>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/jquery-2.1.1.min.js"></script>
    <script>
        // TODO be consistent with use of quotation marks (choose single quotes over double)
        // TODO this file has too many scripts: use a separate .js file. (ideally, for the styling as well)
        
        // FIXME limit # of messages displayed in window (delete and move up after x, or add scrolling. Make container fixed size
        // FIXME lobby (list of users) alternate background color is skewed
        // TODO use a unique background color for each user's messages!
        // TODO Show list of current peers in side pannel
        // TODO notify other peers when new peer is added  
        //  1   SIGN IN
        //  1.a connect to host
        var socket = io(); 
        
        var my_username = 'default';
        //  1.b Prompt user for name
        my_username = prompt("Please enter your name");

        //  1.c Check that username is valid: /\S/ checks that there is at least one none blank character in the name provided
        // TODO: limmit username length to something reasonable (that won't break the display)
        // TODO: limit character set to letters,numbers and spaces/underscore/dash/etc. But no '\'. 
        while (!(/\S/.test(my_username))) {
            my_username = prompt("Your name cannot be left blank! Please enter your name again");
        }

        //  1.d send username to server
        // TODO: put the init/username forward into a function triggered inside the while loop so that we can use var data
        // TODO ... without it being in the scope of other  functions/event (can you redeclare variable inside a function without integrity conflict?)
        socket.emit('sign in',my_username); 

        
        //  3   UPDATE LOBBY (list of online users)
        // TODO implement scrolling in lobby (userlist) or make sure server always limits the number of users to what's visible
        socket.on('update lobby', function(users_list){
            
            // 3.a clear lobby 
            $('#users').empty();

            // 3.b add users to lobby 
            for(var i=0; i < users_list.length; i++){
                $('#users').append($('<li draggable="true" ondragstart="drag(event)">').text(users_list[i]));
            }
        });
        
        //  4   SEARCH FOR USERS
        // search for other users online (submitted everytime text input in search box is changed) 
        $("#search").on("input", function() {
            socket.emit('search',$('#search').val()); // emit search event and pass query/content of search box
        });


        //  6   SEND A CHAT INVITE
        //       Drag and drop someone's name in order to send him/her an invite  
        function drop(ev,type) { 
            ev.preventDefault();
            var peer_username = ev.dataTransfer.getData("text"); // drag and drop transfers username
            var invite = {}; 
            invite['type'] = type; // type = 'new' or 'current' (chat with this user only, or add user to current chat) 
            invite['to'] = peer_username;
            invite['from'] = my_username; 
            console.log('Inviting ' + peer_username +' to '+ type + ' chat');
            socket.emit('invite', invite);
        }
        
        // functions to enable drag and drop
        function allowDrop(ev) { // TODO explain what default event is
            ev.preventDefault();
        }
        
        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.innerHTML); // sets username contained in dragged element as transfer data
        }
        
        
        // 8    RSVP TO CHAT INVITE 
        //      User gets a chat invite from another user. User sends back yes/no reply (rsvp).
        socket.on('invite', function(invite){ // e.g.: invite = {'to':'Nikolay','from':'Ben','type':'new' }  
             
            var rsvp = {}; 
            rsvp['to'] = invite['from']; // swap to and from fields
            rsvp['from'] = invite['to'];
            rsvp['type'] = invite['type'];// server needs to know the invite type to choose the appropriate chat setup (new/private or current/group)   

            // prompt user to either accept or turn down the invite 
            // TODO use invite['type'] to tell user if invited to a private or group chat
            // TODO make names bold to make it more readable 
            if (confirm(invite['from'] + ' just invited you to chat!\n Do you want to chat with '+ invite['from'] +'?')) {
                rsvp['rsvp'] = true; 
                // TODO: append to messages: "You are now talking to: [updated list of peers] " 
            } else {
                rsvp['rsvp'] = false; 
            }
            // send rsvp 
            socket.emit('rsvp', rsvp); // ('rsvp' socket event, rsvp associative array, and rsvp.rsvp = true/false. RSVPs everywhere...)
        });

        //  10  RECEIPT OF RSVP
        socket.on('rsvp', function(rsvp){
            
            if (rsvp['rsvp'] === true){
                alert('Awesome! '+ rsvp['from'] +' accepted your chat invite :)');
                // TODO: append to messages: "You are now talking to: [updated list of peers] " 
            } else {
                alert('Sorry! '+ rsvp['from'] + ' turned down your chat invite :(');
            } 
        });    
        
        // TODO UI: add auto scrolling to bring into view the most recent message 
        // TODO browser notifcation when receiving message and user is not viewing page
        //  11 SEND MESSAGE 
        $('form').submit(function(){
            socket.emit('message', $('#m').val());
            $('#messages').append($('<li style="color:gray; font-weight: 100;">').text('You:\t' + $('#m').val()));
            $('#m').val('');
            return false;
        });
        
        // 12 RECEIVE MESSAGE -- can be from either a chat message or a notification from the server 
        socket.on('message', function(msg){
            // TODO: assign a different color to each user
            if(msg['from'] === 'SERVER')
            {
                var notification =  msg['content'].italics();
                notification =  msg['from'] + ':\t' + notification;
                $('#messages').append('<li>' + notification + '</li>');
            }
            else
            {
                $('#messages').append($('<li>').text(msg['from'] + ':\t' + msg['content']));
            }
        });

    </script>
</body>
</html>
